name: Deploy Staging

# Triggers: automatic on push to main + manual trigger
on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Install backend dependencies
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      # 4️⃣ Run Prisma migrations on Supabase staging
      - name: Run Prisma migrate deploy (Supabase staging)
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_STAGING_DATABASE_URL }}
        run: npx prisma migrate deploy

      # 5️⃣ Deploy backend to Railway
      - name: Deploy backend to Railway (staging)
        working-directory: ./backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_STAGING_SERVICE_ID }}
        run: |
          npm install -g @railway/cli
          railway login --token $RAILWAY_TOKEN
          railway up --service $RAILWAY_SERVICE_ID --non-interactive

      # 6️⃣ Deploy frontend to Vercel (staging)
      - name: Deploy frontend to Vercel (staging)
        working-directory: ./frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_STAGING_ID }}
        run: |
          npm install
          npx vercel deploy --prod --yes

